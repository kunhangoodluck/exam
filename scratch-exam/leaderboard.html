<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’è¡Œæ¦œ - Scratch æœŸæœ«æ¸¬é©—</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="leaderboard-container fade-in">
            <h1 style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">
                ğŸ† æ¸¬é©—æ’è¡Œæ¦œ
            </h1>
            
            <div class="leaderboard-tabs">
                <button class="tab active" data-tab="class">ç­ç´šæ’è¡Œ</button>
                <button class="tab" data-tab="school">æ ¡åœ’æ’è¡Œ</button>
                <button class="tab" data-tab="typing">æ‰“å­—æ’è¡Œ</button>
            </div>
            
            <div id="classLeaderboard" class="leaderboard-content">
                <h2 style="margin-bottom: 20px;">ç­ç´šæ’è¡Œæ¦œ</h2>
                <div style="margin-bottom: 15px;">
                    <select id="classFilter" style="padding: 10px; font-size: 16px; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <option value="">é¸æ“‡ç­ç´š</option>
                        <option value="äº”å¹´ä¸€ç­">äº”å¹´ä¸€ç­</option>
                        <option value="äº”å¹´äºŒç­">äº”å¹´äºŒç­</option>
                        <option value="äº”å¹´ä¸‰ç­">äº”å¹´ä¸‰ç­</option>
                        <option value="äº”å¹´å››ç­">äº”å¹´å››ç­</option>
                        <option value="äº”å¹´äº”ç­">äº”å¹´äº”ç­</option>
                        <option value="äº”å¹´å…­ç­">äº”å¹´å…­ç­</option>
                        <option value="äº”å¹´ä¸ƒç­">äº”å¹´ä¸ƒç­</option>
                        <option value="äº”å¹´å…«ç­">äº”å¹´å…«ç­</option>
                        <option value="äº”å¹´ä¹ç­">äº”å¹´ä¹ç­</option>
                    </select>
                </div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>åº§è™Ÿ</th>
                            <th>å§“å</th>
                            <th>æ¸¬é©—åˆ†æ•¸</th>
                            <th>æ‰“å­—é€Ÿåº¦</th>
                            <th>æ­£ç¢ºç‡</th>
                            <th>ç¶œåˆåˆ†æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="classTableBody">
                        <tr><td colspan="7" style="text-align: center; padding: 40px;">è«‹é¸æ“‡ç­ç´š</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="schoolLeaderboard" class="leaderboard-content" style="display: none;">
                <h2 style="margin-bottom: 20px;">æ ¡åœ’ç¸½æ’è¡Œæ¦œ</h2>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>ç­ç´š</th>
                            <th>å§“å</th>
                            <th>æ¸¬é©—åˆ†æ•¸</th>
                            <th>æ‰“å­—é€Ÿåº¦</th>
                            <th>æ­£ç¢ºç‡</th>
                            <th>ç¶œåˆåˆ†æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="schoolTableBody">
                        <tr><td colspan="7" style="text-align: center; padding: 40px;">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="typingLeaderboard" class="leaderboard-content" style="display: none;">
                <h2 style="margin-bottom: 20px;">æ‰“å­—é€Ÿåº¦æ’è¡Œæ¦œ</h2>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>ç­ç´š</th>
                            <th>å§“å</th>
                            <th>æ‰“å­—é€Ÿåº¦</th>
                            <th>æ­£ç¢ºç‡</th>
                            <th>ç¸½å­—æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="typingTableBody">
                        <tr><td colspan="6" style="text-align: center; padding: 40px;">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="navigation-buttons" style="margin-top: 30px;">
                <button onclick="window.location.href='index.html'" class="btn-secondary">å›åˆ°é¦–é </button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { firebaseConfig } from './js/firebase-config.js';
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let allData = [];
        
        // è¼‰å…¥æ‰€æœ‰è³‡æ–™
        const leaderboardRef = ref(database, 'leaderboard');
        onValue(leaderboardRef, (snapshot) => {
            allData = [];
            snapshot.forEach((childSnapshot) => {
                allData.push(childSnapshot.val());
            });
            
            // åˆå§‹è¼‰å…¥æ ¡åœ’æ’è¡Œæ¦œ
            updateSchoolLeaderboard();
            updateTypingLeaderboard();
        });
        
        // åˆ‡æ›åˆ†é 
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰ active class
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.leaderboard-content').forEach(c => c.style.display = 'none');
                
                // æ·»åŠ  active class
                this.classList.add('active');
                const tabName = this.dataset.tab;
                
                if (tabName === 'class') {
                    document.getElementById('classLeaderboard').style.display = 'block';
                } else if (tabName === 'school') {
                    document.getElementById('schoolLeaderboard').style.display = 'block';
                    updateSchoolLeaderboard();
                } else if (tabName === 'typing') {
                    document.getElementById('typingLeaderboard').style.display = 'block';
                    updateTypingLeaderboard();
                }
            });
        });
        
        // ç­ç´šç¯©é¸
        document.getElementById('classFilter').addEventListener('change', function() {
            const selectedClass = this.value;
            if (!selectedClass) {
                document.getElementById('classTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: 40px;">è«‹é¸æ“‡ç­ç´š</td></tr>';
                return;
            }
            
            const classData = allData
                .filter(student => student.class === selectedClass)
                .sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
            
            if (classData.length === 0) {
                document.getElementById('classTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: 40px;">æ­¤ç­ç´šå°šç„¡æˆç¸¾è³‡æ–™</td></tr>';
                return;
            }
            
            document.getElementById('classTableBody').innerHTML = classData
                .map((student, index) => `
                    <tr>
                        <td>
                            <span class="rank-badge ${getRankClass(index + 1)}">
                                ${index + 1}
                            </span>
                        </td>
                        <td>${student.number || '-'}</td>
                        <td>${student.name}</td>
                        <td>${student.examScore || 0} åˆ†</td>
                        <td>${student.typingWPM || 0} å­—/åˆ†</td>
                        <td>${student.typingAccuracy || 0}%</td>
                        <td><strong>${(student.totalScore || 0).toFixed(1)}</strong></td>
                    </tr>
                `).join('');
        });
        
        // æ›´æ–°æ ¡åœ’æ’è¡Œæ¦œ
        function updateSchoolLeaderboard() {
            const sortedData = [...allData]
                .sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0))
                .slice(0, 50); // åªé¡¯ç¤ºå‰50å
            
            if (sortedData.length === 0) {
                document.getElementById('schoolTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: 40px;">å°šç„¡æˆç¸¾è³‡æ–™</td></tr>';
                return;
            }
            
            document.getElementById('schoolTableBody').innerHTML = sortedData
                .map((student, index) => `
                    <tr>
                        <td>
                            <span class="rank-badge ${getRankClass(index + 1)}">
                                ${index + 1}
                            </span>
                        </td>
                        <td>${student.class}</td>
                        <td>${student.name}</td>
                        <td>${student.examScore || 0} åˆ†</td>
                        <td>${student.typingWPM || 0} å­—/åˆ†</td>
                        <td>${student.typingAccuracy || 0}%</td>
                        <td><strong>${(student.totalScore || 0).toFixed(1)}</strong></td>
                    </tr>
                `).join('');
        }
        
        // æ›´æ–°æ‰“å­—æ’è¡Œæ¦œ
        function updateTypingLeaderboard() {
            const sortedData = [...allData]
                .sort((a, b) => (b.typingWPM || 0) - (a.typingWPM || 0))
                .slice(0, 50);
            
            if (sortedData.length === 0) {
                document.getElementById('typingTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; padding: 40px;">å°šç„¡æˆç¸¾è³‡æ–™</td></tr>';
                return;
            }
            
            document.getElementById('typingTableBody').innerHTML = sortedData
                .map((student, index) => `
                    <tr>
                        <td>
                            <span class="rank-badge ${getRankClass(index + 1)}">
                                ${index + 1}
                            </span>
                        </td>
                        <td>${student.class}</td>
                        <td>${student.name}</td>
                        <td><strong>${student.typingWPM || 0}</strong> å­—/åˆ†</td>
                        <td>${student.typingAccuracy || 0}%</td>
                        <td>${student.typingResult?.totalChars || 0} å­—</td>
                    </tr>
                `).join('');
        }
        
        // å–å¾—æ’åæ¨£å¼
        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }
    </script>
</body>
</html>
