<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹å¼çŸ¥è­˜æ¸¬é©— - Scratch æœŸæœ«æ¸¬é©—</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .question-image {
            width: 100%;
            max-width: 800px;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .timer-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .timer-warning.show {
            display: block;
            animation: pulse 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .question-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .option {
            padding: 20px;
            margin: 12px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-size: 18px;
        }
        
        .option:hover {
            border-color: #FF6B35;
            background: #fff5f2;
        }
        
        .option.selected {
            border-color: #FF6B35;
            background: #fff0eb;
        }
        
        .option input[type="radio"] {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="exam-container fade-in">
            <div class="exam-header">
                <div>
                    <h1>ğŸ“ Scratch ç¨‹å¼çŸ¥è­˜æ¸¬é©—</h1>
                    <p id="studentInfo" class="subtitle"></p>
                </div>
                <div class="exam-progress">
                    <span id="questionCounter">é¡Œç›® 1/24</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
            
            <div class="timer-warning" id="timerWarning">
                â±ï¸ è«‹ä»”ç´°é–±è®€é¡Œç›®ï¼Œé‚„éœ€è¦ <span id="remainingTime">5</span> ç§’æ‰èƒ½é€²å…¥ä¸‹ä¸€é¡Œ
            </div>
            
            <div id="questionContainer">
                <!-- é¡Œç›®æœƒå‹•æ…‹è¼‰å…¥ -->
            </div>
            
            <div class="navigation-buttons">
                <button id="prevBtn" class="btn-secondary" style="display: none;">ä¸Šä¸€é¡Œ</button>
                <div style="flex: 1;"></div>
                <button id="nextBtn" class="btn-primary" disabled>ä¸‹ä¸€é¡Œ</button>
                <button id="submitBtn" class="btn-submit" style="display: none;">å®Œæˆæ¸¬é©—</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { firebaseConfig } from './js/firebase-config.js';
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const studentData = JSON.parse(sessionStorage.getItem('studentData'));
        if (!studentData) {
            alert('è«‹å…ˆç™»å…¥ï¼');
            window.location.href = 'index.html';
        }
        
        document.getElementById('studentInfo').textContent = 
            `${studentData.class} ${studentData.number}è™Ÿ`;
        
        // æ¸¬é©—è¨­å®š
        const MIN_ANSWER_TIME = 5; // æœ€ä½ç­”é¡Œæ™‚é–“ï¼ˆç§’ï¼‰
        let questions = [];
        let currentQuestion = 0;
        let answers = {};
        let questionStartTime = 0;
        let timerInterval = null;
        
        // è¼‰å…¥é¡Œç›®
        fetch('data/questions.json')
            .then(response => response.json())
            .then(data => {
                questions = data;
                showQuestion(0);
            })
            .catch(error => {
                console.error('è¼‰å…¥é¡Œç›®å¤±æ•—:', error);
                alert('è¼‰å…¥é¡Œç›®å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            });
        
        function showQuestion(index) {
            currentQuestion = index;
            const question = questions[index];
            
            // ç¢ºä¿ä»‹é¢å…ƒç´ å¯è¦‹
            const container = document.getElementById('questionContainer');
            const timerWarning = document.getElementById('timerWarning');
            const navButtons = document.querySelector('.navigation-buttons');
            
            if (container) container.style.display = 'block';
            if (navButtons) navButtons.style.display = 'flex';
            
            // è¨˜éŒ„é–‹å§‹æ™‚é–“
            questionStartTime = Date.now();
            
            // é‡ç½®è¨ˆæ™‚å™¨
            startTimer();
            
            // æ›´æ–°é€²åº¦
            document.getElementById('questionCounter').textContent = 
                `é¡Œç›® ${index + 1}/${questions.length}`;
            document.getElementById('progressFill').style.width = 
                `${((index + 1) / questions.length) * 100}%`;
            
            // é¡¯ç¤ºé¡Œç›®
            container.innerHTML = `
                <div class="question-navigator" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="font-size: 14px; color: #666; margin-bottom: 12px; font-weight: bold;">ğŸ“‹ é¡Œç›®åˆ—è¡¨ï¼ˆé»æ“Šå¯å¿«é€Ÿè·³é¡Œï¼‰</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px;">
                        ${questions.map((q, idx) => {
                            const answered = answers[q.id] !== undefined;
                            const isCurrent = idx === index;
                            let bgColor = '#f5f5f5';
                            let borderColor = '#ddd';
                            let textColor = '#666';
                            
                            if (isCurrent) {
                                bgColor = '#FF6B35';
                                borderColor = '#FF6B35';
                                textColor = 'white';
                            } else if (answered) {
                                bgColor = '#e3f2fd';
                                borderColor = '#2196f3';
                                textColor = '#1565c0';
                            }
                            
                            return `
                                <button onclick="jumpToQuestion(${idx})" style="
                                    background: ${bgColor};
                                    border: 2px solid ${borderColor};
                                    padding: 10px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-size: 14px;
                                    font-weight: bold;
                                    color: ${textColor};
                                " onmouseover="if(!${isCurrent}) { this.style.transform='scale(1.1)'; this.style.borderColor='#FF6B35'; }" onmouseout="if(!${isCurrent}) { this.style.transform='scale(1)'; this.style.borderColor='${borderColor}'; }">
                                    ${answered && !isCurrent ? 'âœ“' : ''} ${q.id}
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: #999;">
                        <span style="display: inline-block; margin-right: 15px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: #FF6B35; border-radius: 3px; margin-right: 5px; vertical-align: middle;"></span>
                            ç•¶å‰é¡Œç›®
                        </span>
                        <span style="display: inline-block; margin-right: 15px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 3px; margin-right: 5px; vertical-align: middle;"></span>
                            å·²ä½œç­”
                        </span>
                        <span style="display: inline-block;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: #f5f5f5; border: 2px solid #ddd; border-radius: 3px; margin-right: 5px; vertical-align: middle;"></span>
                            æœªä½œç­”
                        </span>
                    </div>
                </div>
                
                <div class="question-card">
                    <div class="question-number">ç¬¬ ${index + 1} é¡Œ</div>
                    <div class="question-text">${question.question}</div>
                    ${question.image ? `<img src="images/${question.image}" class="question-image" alt="é¡Œç›®åœ–ç‰‡">` : ''}
                    <div class="options">
                        ${question.options.map((option, i) => `
                            <label class="option ${answers[question.id] === i ? 'selected' : ''}">
                                <input type="radio" 
                                       name="question${question.id}" 
                                       value="${i}"
                                       ${answers[question.id] === i ? 'checked' : ''}
                                       onchange="selectAnswer(${question.id}, ${i})">
                                <span>${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            updateNavigationButtons();
        }
        
        function startTimer() {
            let timeLeft = MIN_ANSWER_TIME;
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const btnTimer = document.getElementById('btnTimer');
            const remainingTime = document.getElementById('remainingTime');
            const timerWarning = document.getElementById('timerWarning');
            
            // ç¦ç”¨æŒ‰éˆ•
            nextBtn.disabled = true;
            submitBtn.disabled = true;
            
            // é¡¯ç¤ºè­¦å‘Š
            timerWarning.classList.add('show');
            
            // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
            if (currentQuestion === questions.length - 1) {
                submitBtn.innerHTML = `å®Œæˆæ¸¬é©— (<span id="btnTimer">${timeLeft}</span>ç§’)`;
            } else {
                nextBtn.innerHTML = `ä¸‹ä¸€é¡Œ (<span id="btnTimer">${timeLeft}</span>ç§’)`;
            }
            remainingTime.textContent = timeLeft;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                
                // æ›´æ–°é¡¯ç¤º
                const currentBtnTimer = document.getElementById('btnTimer');
                if (currentBtnTimer) {
                    currentBtnTimer.textContent = timeLeft;
                }
                remainingTime.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    nextBtn.disabled = false;
                    submitBtn.disabled = false;
                    
                    // æ¢å¾©æŒ‰éˆ•æ–‡å­—
                    if (currentQuestion === questions.length - 1) {
                        submitBtn.innerHTML = 'å®Œæˆæ¸¬é©—';
                    } else {
                        nextBtn.innerHTML = 'ä¸‹ä¸€é¡Œ';
                    }
                    
                    timerWarning.classList.remove('show');
                }
            }, 1000);
        }
        
        window.selectAnswer = function(questionId, optionIndex) {
            answers[questionId] = optionIndex;
            
            // æ›´æ–°é¸é …æ¨£å¼
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.option').classList.add('selected');
        };
        
        // è·³åˆ°æŒ‡å®šé¡Œç›®
        window.jumpToQuestion = function(index) {
            // æ¸…é™¤è¨ˆæ™‚å™¨
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            showQuestion(index);
        };
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            // ä¸Šä¸€é¡ŒæŒ‰éˆ•
            if (currentQuestion > 0) {
                prevBtn.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
            }
            
            // ä¸‹ä¸€é¡Œ / å®ŒæˆæŒ‰éˆ•
            if (currentQuestion === questions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }
        
        // ä¸Šä¸€é¡Œ
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentQuestion > 0) {
                // æ¸…é™¤è¨ˆæ™‚å™¨
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                showQuestion(currentQuestion - 1);
            }
        });
        
        // ä¸‹ä¸€é¡Œ
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentQuestion < questions.length - 1) {
                // æ¸…é™¤è¨ˆæ™‚å™¨
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                showQuestion(currentQuestion + 1);
            }
        });
        
        // å®Œæˆæ¸¬é©—
        document.getElementById('submitBtn').addEventListener('click', () => {
            showReviewPage();
        });
        
        // é¡¯ç¤ºç­”é¡Œæª¢æŸ¥é é¢
        function showReviewPage() {
            // æ¸…é™¤è¨ˆæ™‚å™¨
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // éš±è—é¡Œç›®å’ŒæŒ‰éˆ•ï¼ˆä¸åˆªé™¤ï¼Œåªæ˜¯éš±è—ï¼‰
            document.getElementById('questionContainer').style.display = 'none';
            document.getElementById('timerWarning').style.display = 'none';
            document.querySelector('.navigation-buttons').style.display = 'none';
            document.querySelector('.exam-header').style.display = 'none';
            
            // çµ±è¨ˆä½œç­”æƒ…æ³ï¼ˆä¸è¨ˆç®—å°éŒ¯ï¼‰
            const answeredCount = questions.filter(q => answers[q.id] !== undefined).length;
            const unansweredCount = questions.length - answeredCount;
            
            // å»ºç«‹è©³ç´°çµæœï¼ˆè€ƒè©¦çµæŸå¾Œæ‰è¨ˆç®—å°éŒ¯ï¼‰
            const detailedResults = [];
            questions.forEach(q => {
                const userAnswer = answers[q.id];
                detailedResults.push({
                    questionId: q.id,
                    question: q.question,
                    userAnswer: userAnswer !== undefined ? userAnswer : null,
                    correctAnswer: q.correctAnswer,
                    answered: userAnswer !== undefined
                });
            });
            
            // å»ºç«‹æˆ–æ›´æ–°æª¢æŸ¥é é¢
            let reviewContainer = document.getElementById('reviewContainer');
            if (!reviewContainer) {
                reviewContainer = document.createElement('div');
                reviewContainer.id = 'reviewContainer';
                document.querySelector('.exam-container').appendChild(reviewContainer);
            }
            
            reviewContainer.style.display = 'block';
            reviewContainer.innerHTML = `
                <div class="review-content" style="padding: 30px;">
                    <h1 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">
                        ğŸ“‹ ç­”é¡Œæª¢æŸ¥
                    </h1>
                    
                    <div class="score-summary" style="background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å·²ä½œç­”é¡Œæ•¸</div>
                                <div style="font-size: 36px; font-weight: bold; color: #4caf50;">${answeredCount} / ${questions.length}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">æœªä½œç­”é¡Œæ•¸</div>
                                <div style="font-size: 36px; font-weight: bold; color: ${unansweredCount > 0 ? '#f44336' : '#4caf50'};">${unansweredCount} é¡Œ</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å®Œæˆåº¦</div>
                                <div style="font-size: 36px; font-weight: bold; color: #FF6B35;">${Math.round(answeredCount / questions.length * 100)}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #856404;">ğŸ’¡ æç¤ºï¼šå¯ä»¥é»æ“Šé¡Œè™Ÿå¿«é€Ÿè·³åˆ°è©²é¡Œè£œç­”æˆ–ä¿®æ”¹ç­”æ¡ˆ</p>
                    </div>
                    
                    <div class="question-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        ${questions.map(q => {
                            const answered = answers[q.id] !== undefined;
                            let bgColor = answered ? '#e3f2fd' : '#f5f5f5';
                            let textColor = answered ? '#1565c0' : '#666';
                            let borderColor = answered ? '#2196f3' : '#ddd';
                            let icon = answered ? 'âœ“' : '?';
                            
                            return `
                                <button onclick="goToQuestionFromReview(${q.id - 1})" style="
                                    background: ${bgColor};
                                    border: 2px solid ${borderColor};
                                    padding: 15px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    font-size: 16px;
                                    font-weight: bold;
                                    color: ${textColor};
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    ${icon} ç¬¬ ${q.id} é¡Œ
                                </button>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="continueExam()" class="btn-secondary" style="margin-right: 15px; padding: 15px 40px; font-size: 18px;">
                            â† ç¹¼çºŒä½œç­”
                        </button>
                        <button onclick="submitFinalExam()" class="btn-submit" style="padding: 15px 40px; font-size: 18px;">
                            ${unansweredCount > 0 ? 'ç¢ºå®šäº¤å·ï¼ˆæœ‰æœªä½œç­”é¡Œç›®ï¼‰' : 'ç¢ºå®šäº¤å·'} â†’
                        </button>
                    </div>
                </div>
            `;
            
            // å°‡è©³ç´°çµæœå­˜åˆ°å…¨åŸŸè®Šæ•¸
            window.detailedResults = detailedResults;
        }
        
        // å¾æª¢æŸ¥é é¢è·³åˆ°æŒ‡å®šé¡Œç›®
        window.goToQuestionFromReview = function(index) {
            // éš±è—æª¢æŸ¥é é¢
            const reviewContainer = document.getElementById('reviewContainer');
            if (reviewContainer) {
                reviewContainer.style.display = 'none';
            }
            
            // é¡¯ç¤ºåŸå§‹ä»‹é¢
            document.querySelector('.exam-header').style.display = 'flex';
            
            // è·³åˆ°æŒ‡å®šé¡Œç›®
            showQuestion(index);
        };
        
        // è·³åˆ°æŒ‡å®šé¡Œç›®ï¼ˆå¾é¡Œç›®åˆ—è¡¨ï¼‰
        window.jumpToQuestion = function(index) {
            // æ¸…é™¤è¨ˆæ™‚å™¨
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            showQuestion(index);
        };
        
        // ç¹¼çºŒä½œç­”
        window.continueExam = function() {
            // éš±è—æª¢æŸ¥é é¢
            const reviewContainer = document.getElementById('reviewContainer');
            if (reviewContainer) {
                reviewContainer.style.display = 'none';
            }
            
            // é¡¯ç¤ºåŸå§‹ä»‹é¢
            document.querySelector('.exam-header').style.display = 'flex';
            
            // å›åˆ°ç•¶å‰é¡Œç›®
            showQuestion(currentQuestion);
        };
        
        // æœ€çµ‚æäº¤
        window.submitFinalExam = async function() {
            const unanswered = questions.filter(q => answers[q.id] === undefined);
            
            if (unanswered.length > 0) {
                const confirmSubmit = confirm(`é‚„æœ‰ ${unanswered.length} é¡Œæœªä½œç­”ï¼Œç¢ºå®šè¦äº¤å·å—ï¼Ÿ`);
                if (!confirmSubmit) return;
            }
            
            // è¨ˆç®—æˆç¸¾ï¼ˆåœ¨æäº¤æ™‚æ‰è¨ˆç®—ï¼‰
            let correctCount = 0;
            const detailedResults = [];
            
            questions.forEach(q => {
                const userAnswer = answers[q.id];
                const isCorrect = userAnswer === q.correctAnswer;
                if (isCorrect) correctCount++;
                
                detailedResults.push({
                    questionId: q.id,
                    question: q.question,
                    userAnswer: userAnswer !== undefined ? userAnswer : null,
                    correctAnswer: q.correctAnswer,
                    isCorrect: isCorrect,
                    answered: userAnswer !== undefined
                });
            });
            
            const score = Math.round((correctCount / questions.length) * 100);
            
            // å„²å­˜æ¸¬é©—çµæœï¼ˆåŒ…å«è©³ç´°ç­”é¡Œè¨˜éŒ„ï¼‰
            studentData.examResult = {
                answers: answers,
                detailedResults: detailedResults,
                correctCount: correctCount,
                totalQuestions: questions.length,
                score: score,
                completedTime: new Date().toISOString()
            };
            
            sessionStorage.setItem('studentData', JSON.stringify(studentData));
            
            // å„²å­˜åˆ° Firebase
            const studentKey = `${studentData.class}_${studentData.number}_${studentData.name}`;
            try {
                await set(ref(database, `exams/${studentKey}`), {
                    name: studentData.name,
                    class: studentData.class,
                    number: studentData.number,
                    examResult: studentData.examResult,
                    loginTime: studentData.loginTime
                });
                
                // è·³è½‰åˆ°æ‰“å­—æ¸¬é©—
                alert(`æ¸¬é©—å®Œæˆï¼\nç­”å° ${correctCount} é¡Œï¼Œå…± ${questions.length} é¡Œ\næˆç¸¾ï¼š${score} åˆ†`);
                window.location.href = 'typing.html';
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜æˆç¸¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯çµ¡è€å¸«');
            }
        };
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦è·³åˆ°æŒ‡å®šé¡Œç›®
        const jumpTo = sessionStorage.getItem('jumpToQuestion');
        if (jumpTo !== null) {
            sessionStorage.removeItem('jumpToQuestion');
            setTimeout(() => {
                showQuestion(parseInt(jumpTo));
            }, 100);
        }
    </script>
</body>
</html>
