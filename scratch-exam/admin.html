<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - Scratch æœŸæœ«æ¸¬é©—</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-panel {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
        }
        
        .admin-section {
            margin-bottom: 40px;
            padding: 30px;
            background: var(--bg-light);
            border-radius: 8px;
        }
        
        .admin-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .export-btn {
            padding: 12px 30px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .export-btn:hover {
            background: #45a049;
        }
        
        .danger-btn {
            padding: 12px 30px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .danger-btn:hover {
            background: #da190b;
        }
        
        .data-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            background: var(--primary-color);
            color: white;
        }
        
        .data-table tr:hover {
            background: var(--bg-light);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-panel fade-in">
            <h1 style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">
                âš™ï¸ ç®¡ç†å¾Œå°
            </h1>
            
            <!-- é©—è­‰å€åŸŸ -->
            <div id="authSection" class="admin-section">
                <h2>èº«ä»½é©—è­‰</h2>
                <p style="color: var(--text-light); margin-bottom: 20px;">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼</p>
                <input 
                    type="password" 
                    id="adminPassword" 
                    placeholder="ç®¡ç†å“¡å¯†ç¢¼"
                    style="padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; width: 300px;">
                <button onclick="verifyPassword()" class="btn-primary" style="margin-left: 10px;">ç™»å…¥</button>
            </div>
            
            <!-- ç®¡ç†åŠŸèƒ½å€åŸŸï¼ˆéœ€é©—è­‰å¾Œé¡¯ç¤ºï¼‰-->
            <div id="adminContent" style="display: none;">
                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div class="admin-section">
                    <h2>æ¸¬é©—çµ±è¨ˆ</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-number" id="totalStudents">0</div>
                            <div class="stat-label">åƒèˆ‡äººæ•¸</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="avgExamScore">0</div>
                            <div class="stat-label">å¹³å‡æ¸¬é©—åˆ†æ•¸</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="avgTypingSpeed">0</div>
                            <div class="stat-label">å¹³å‡æ‰“å­—é€Ÿåº¦</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="avgAccuracy">0</div>
                            <div class="stat-label">å¹³å‡æ­£ç¢ºç‡</div>
                        </div>
                    </div>
                </div>
                
                <!-- è³‡æ–™ç®¡ç† -->
                <div class="admin-section">
                    <h2>è³‡æ–™ç®¡ç†</h2>
                    <button onclick="exportToCSV()" class="export-btn">ğŸ“¥ åŒ¯å‡ºæˆç¸¾ CSV</button>
                    <button onclick="exportToJSON()" class="export-btn">ğŸ“¥ åŒ¯å‡ºæˆç¸¾ JSON</button>
                    <button onclick="clearAllData()" class="danger-btn">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                </div>
                
                <!-- å­¸ç”Ÿæˆç¸¾åˆ—è¡¨ -->
                <div class="admin-section">
                    <h2>å­¸ç”Ÿæˆç¸¾åˆ—è¡¨</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="studentDataTable">
                            <thead>
                                <tr>
                                    <th>ç­ç´š</th>
                                    <th>åº§è™Ÿ</th>
                                    <th>å§“å</th>
                                    <th>æ¸¬é©—åˆ†æ•¸</th>
                                    <th>æ‰“å­—é€Ÿåº¦</th>
                                    <th>æ­£ç¢ºç‡</th>
                                    <th>å®Œæˆæ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody">
                                <tr><td colspan="8" style="text-align: center;">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { firebaseConfig } from './js/firebase-config.js';
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let allStudentData = [];
        
        // ç®¡ç†å“¡å¯†ç¢¼ï¼ˆå¯¦éš›ä½¿ç”¨æ™‚æ‡‰è©²æ”¹ç‚ºæ›´å®‰å…¨çš„é©—è­‰æ–¹å¼ï¼‰
        const ADMIN_PASSWORD = 'scratch2024';
        
        window.verifyPassword = function() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadData();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        };
        
        // è¼‰å…¥è³‡æ–™
        function loadData() {
            const leaderboardRef = ref(database, 'leaderboard');
            onValue(leaderboardRef, (snapshot) => {
                allStudentData = [];
                snapshot.forEach((childSnapshot) => {
                    allStudentData.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                updateStatistics();
                updateStudentTable();
            });
        }
        
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            document.getElementById('totalStudents').textContent = allStudentData.length;
            
            if (allStudentData.length > 0) {
                const avgExam = allStudentData.reduce((sum, s) => sum + (s.examScore || 0), 0) / allStudentData.length;
                const avgSpeed = allStudentData.reduce((sum, s) => sum + (s.typingWPM || 0), 0) / allStudentData.length;
                const avgAcc = allStudentData.reduce((sum, s) => sum + (s.typingAccuracy || 0), 0) / allStudentData.length;
                
                document.getElementById('avgExamScore').textContent = avgExam.toFixed(1);
                document.getElementById('avgTypingSpeed').textContent = avgSpeed.toFixed(1);
                document.getElementById('avgAccuracy').textContent = avgAcc.toFixed(1) + '%';
            }
        }
        
        // æ›´æ–°å­¸ç”Ÿè¡¨æ ¼
        function updateStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            
            if (allStudentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">å°šç„¡è³‡æ–™</td></tr>';
                return;
            }
            
            tbody.innerHTML = allStudentData
                .sort((a, b) => new Date(b.completedTime) - new Date(a.completedTime))
                .map(student => `
                    <tr>
                        <td>${student.class || '-'}</td>
                        <td>${student.number || '-'}</td>
                        <td>${student.name || '-'}</td>
                        <td>${student.examScore || 0} åˆ†</td>
                        <td>${student.typingWPM || 0} å­—/åˆ†</td>
                        <td>${student.typingAccuracy || 0}%</td>
                        <td>${new Date(student.completedTime).toLocaleString('zh-TW')}</td>
                        <td>
                            <button onclick="deleteStudent('${student.id}')" 
                                    style="padding: 5px 15px; background: var(--danger-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                åˆªé™¤
                            </button>
                        </td>
                    </tr>
                `).join('');
        }
        
        // åˆªé™¤å­¸ç”Ÿè³‡æ–™
        window.deleteStudent = async function(studentId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return;
            
            try {
                await remove(ref(database, `leaderboard/${studentId}`));
                await remove(ref(database, `exams/${studentId}`));
                alert('åˆªé™¤æˆåŠŸï¼');
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        };
        
        // åŒ¯å‡º CSV
        window.exportToCSV = function() {
            const headers = ['ç­ç´š', 'åº§è™Ÿ', 'å§“å', 'æ¸¬é©—åˆ†æ•¸', 'æ‰“å­—é€Ÿåº¦', 'æ­£ç¢ºç‡', 'ç¸½å­—æ•¸', 'å®Œæˆæ™‚é–“'];
            const rows = allStudentData.map(s => [
                s.class || '',
                s.number || '',
                s.name || '',
                s.examScore || 0,
                s.typingWPM || 0,
                s.typingAccuracy || 0,
                s.typingResult?.totalChars || 0,
                new Date(s.completedTime).toLocaleString('zh-TW')
            ]);
            
            let csv = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `scratchæœŸæœ«æ¸¬é©—æˆç¸¾_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };
        
        // åŒ¯å‡º JSON
        window.exportToJSON = function() {
            const json = JSON.stringify(allStudentData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `scratchæœŸæœ«æ¸¬é©—æˆç¸¾_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        };
        
        // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
        window.clearAllData = async function() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ¸¬é©—è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
            if (!confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;
            
            try {
                await remove(ref(database, 'leaderboard'));
                await remove(ref(database, 'exams'));
                alert('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºï¼');
            } catch (error) {
                alert('æ¸…ç©ºå¤±æ•—ï¼š' + error.message);
            }
        };
    </script>
</body>
</html>
