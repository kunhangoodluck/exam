<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å­—æ¸¬é©— - Scratch æœŸæœ«æ¸¬é©—</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .typing-reference {
            width: 100%;
            max-width: 1200px;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 8px;
        }
        
        .typing-input-container {
            margin: 30px 0;
        }
        
        .typing-input {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            border: 3px solid #FF6B35;
            border-radius: 8px;
            font-family: 'Microsoft JhengHei', sans-serif;
            line-height: 1.8;
            min-height: 120px;
        }
        
        .typing-input:focus {
            outline: none;
            border-color: #e55a2b;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #FF6B35;
        }
        
        .stat-unit {
            font-size: 16px;
            color: #999;
            margin-left: 5px;
        }
        
        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #FF6B35;
            text-align: center;
            margin: 20px 0;
        }
        
        .timer-display.warning {
            color: #dc3545;
            animation: blink 1s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .round-indicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .instruction {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .instruction p {
            margin: 5px 0;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="typing-container fade-in">
            <div class="typing-header">
                <h1>âŒ¨ï¸ ä¸­æ–‡æ‰“å­—æ¸¬é©—</h1>
                <p id="studentInfo" class="subtitle"></p>
            </div>
            
            <div class="timer-display" id="timerDisplay">05:00</div>
            
            <div class="round-indicator" id="roundIndicator">
                ç¬¬ 1 è¼ª - ã€Šé¹¿æŸ´ã€‹
            </div>
            
            <div class="instruction">
                <p>ğŸ“ è«‹ä¾ç…§ä¸‹æ–¹æ³¨éŸ³æç¤ºï¼Œè¼¸å…¥å®Œæ•´çš„è©©å¥</p>
                <p>ğŸ”„ å…©é¦–è©©è¼ªæµå‡ºç¾ï¼šã€Šé¹¿æŸ´ã€‹å’Œã€Šé³¥é³´æ¾—ã€‹</p>
                <p>â æ‰“å®Œä¸€é¦–è©©å¾Œï¼ŒæŒ‰ <strong>Enter éµ</strong>é–‹å§‹ä¸‹ä¸€è¼ª</p>
                <p>â±ï¸ æ¸¬é©—æ™‚é–“ï¼š<strong>6 åˆ†é˜</strong></p>
                <p id="elapsedTime" style="font-size: 24px; font-weight: bold; color: #FF6B35; margin-top: 10px;">â° å·²ç”¨æ™‚é–“ï¼š00:00</p>
            </div>
            
            <img id="poemImage" src="images/typing-poem1.png" alt="æ‰“å­—åƒè€ƒ" class="typing-reference">
            
            <div class="typing-input-container">
                <textarea 
                    id="typingInput" 
                    class="typing-input" 
                    placeholder="è«‹é–‹å§‹æ‰“å­—...ï¼ˆæ‰“å®Œå¾ŒæŒ‰ Enter é–‹å§‹ä¸‹ä¸€è¼ªï¼‰"
                    disabled
                ></textarea>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="grid-column: span 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">ğŸ† ç¶œåˆåˆ†æ•¸</div>
                    <div class="stat-value" style="color: white; font-size: 48px;" id="overallScore">0<span class="stat-unit" style="color: rgba(255,255,255,0.9);">åˆ†</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ğŸ“ å®Œæˆç‡ <span id="completionBadge"></span></div>
                    <div class="stat-value" id="completionRate">0<span class="stat-unit">%</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">âœ“ æ­£ç¢ºç‡ <span id="accuracyBadge"></span></div>
                    <div class="stat-value" id="accuracy">100<span class="stat-unit">%</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">âš¡ æ‰“å­—é€Ÿåº¦ <span id="speedBadge"></span></div>
                    <div class="stat-value" id="wpm">0<span class="stat-unit">å­—/åˆ†</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å®Œæˆè¼ªæ•¸</div>
                    <div class="stat-value" id="roundCount">0<span class="stat-unit">è¼ª</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç¸½æ‰“å­—æ•¸</div>
                    <div class="stat-value" id="totalChars">0<span class="stat-unit">å­—</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">éŒ¯å­—æ•¸</div>
                    <div class="stat-value" id="errorCount">0<span class="stat-unit">å­—</span></div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button id="startBtn" class="btn-primary">é–‹å§‹æ¸¬é©—</button>
                <button id="submitBtn" class="btn-submit" style="display: none;">æäº¤æˆç¸¾</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { firebaseConfig } from './js/firebase-config.js';
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const studentData = JSON.parse(sessionStorage.getItem('studentData'));
        if (!studentData || !studentData.examResult) {
            alert('è«‹å…ˆå®Œæˆç¨‹å¼æ¸¬é©—ï¼');
            window.location.href = 'exam.html';
        }
        
        document.getElementById('studentInfo').textContent = 
            `${studentData.class} ${studentData.number}è™Ÿ`;
        
        // æ¸¬é©—è¨­å®š
        const TEST_DURATION = 360; // 6åˆ†é˜ = 360ç§’
        const POEMS = [
            'ç©ºå±±ä¸è¦‹äººï¼Œä½†èäººèªéŸ¿ã€‚è¿”æ™¯å…¥æ·±æ—ï¼Œå¾©ç…§é’è‹”ä¸Šã€‚',
            'äººé–’æ¡‚èŠ±è½ï¼Œå¤œéœæ˜¥å±±ç©ºã€‚æœˆå‡ºé©šå±±é³¥ï¼Œæ™‚é³´æ˜¥æ¾—ä¸­ã€‚'
        ];
        let currentPoemIndex = 0;
        
        function getCurrentPoem() {
            return POEMS[currentPoemIndex];
        }
        
        function nextPoem() {
            currentPoemIndex = (currentPoemIndex + 1) % POEMS.length;
            return getCurrentPoem();
        }
        
        // åŒéŸ³å­—å°ç…§è¡¨ï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯ä»¥æ“´å……ï¼‰
        const HOMOPHONE_MAP = {
            ',': ['ï¼Œ'],  // è‹±æ–‡é€—è™Ÿ vs ä¸­æ–‡é€—è™Ÿ
            'ï¼Œ': [','],  // ä¸­æ–‡é€—è™Ÿ vs è‹±æ–‡é€—è™Ÿ
            'åœ¨': ['å†', 'è¼‰'],
            'å†': ['åœ¨', 'è¼‰'],
            'çš„': ['å¾—', 'åœ°'],
            'å¾—': ['çš„', 'åœ°'],
            'åœ°': ['çš„', 'å¾—'],
            'åš': ['ä½œ'],
            'ä½œ': ['åš'],
            'åƒ': ['è±¡'],
            'è±¡': ['åƒ'],
            'åœ’': ['åœ“'],
            'åœ“': ['åœ’'],
            'å…ƒ': ['åŸ', 'åœ’'],
            'åŸ': ['å…ƒ'],
            'ç¾': ['è¦‹'],
            'è¦‹': ['ç¾'],
            'è': ['æ–‡'],
            'æ–‡': ['è'],
            'è¿”': ['å'],
            'å': ['è¿”'],
            'æ™¯': ['å½±'],
            'å½±': ['æ™¯'],
            'å¾©': ['è¤‡', 'è…¹'],
            'è¤‡': ['å¾©'],
            'ç…§': ['æ‰¾', 'å¬'],
            'æ‰¾': ['ç…§'],
            'å¬': ['ç…§'],
            'å°': ['è‹”', 'æª¯'],
            'è‹”': ['å°', 'æª¯'],
            'ä¸Š': ['å°š'],
            'å°š': ['ä¸Š'],
            'é–’': ['é–“'],
            'é–“': ['é–’'],
            'æ¡‚': ['è²´'],
            'è²´': ['æ¡‚'],
            'èŠ±': ['è¯'],
            'è¯': ['èŠ±'],
            'è½': ['æ´›'],
            'æ´›': ['è½'],
            'å¤œ': ['ä¹Ÿ'],
            'ä¹Ÿ': ['å¤œ'],
            'éœ': ['æ·¨', 'ç«¶'],
            'æ·¨': ['éœ'],
            'ç«¶': ['éœ'],
            'æ˜¥': ['æ¤¿'],
            'æ¤¿': ['æ˜¥'],
            'å±±': ['ä¸‰'],
            'ä¸‰': ['å±±'],
            'ç©º': ['æ§'],
            'æ§': ['ç©º'],
            'æœˆ': ['è¶Š', 'æ‚…'],
            'è¶Š': ['æœˆ'],
            'æ‚…': ['æœˆ'],
            'å‡º': ['è™•'],
            'è™•': ['å‡º'],
            'é©š': ['äº¬'],
            'äº¬': ['é©š'],
            'é³¥': ['å³¶'],
            'å³¶': ['é³¥'],
            'æ™‚': ['å¸‚', 'æ˜¯'],
            'å¸‚': ['æ™‚'],
            'æ˜¯': ['æ™‚'],
            'é³´': ['å', 'æ˜'],
            'å': ['é³´'],
            'æ˜': ['é³´'],
            'æ¾—': ['é–“'],
            'ä¸­': ['å¿ ', 'çµ‚'],
            'å¿ ': ['ä¸­'],
            'çµ‚': ['ä¸­']
        };
        
        // æ¸¬é©—ç‹€æ…‹
        let timeRemaining = TEST_DURATION;
        let timerInterval = null;
        let startTime = null;
        let roundCount = 0;
        let totalChars = 0;
        let totalErrors = 0; // å¯èƒ½æ˜¯å°æ•¸ï¼ˆåŒéŸ³å­—ç®—0.5ï¼‰
        let currentRound = 1;
        let roundCompletionRates = []; // å„²å­˜æ¯è¼ªå®Œæˆç‡
        
        // é–‹å§‹æ¸¬é©—
        document.getElementById('startBtn').addEventListener('click', startTest);
        
        let elapsedSeconds = 0;
        let elapsedTimerInterval = null;
        
        function startTest() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('typingInput').disabled = false;
            document.getElementById('typingInput').focus();
            
            startTime = Date.now();
            startTimer();
            startElapsedTimer(); // å•Ÿå‹•ç¶“éæ™‚é–“è¨ˆæ™‚å™¨
        }
        
        // ç¶“éæ™‚é–“è¨ˆæ™‚å™¨
        function startElapsedTimer() {
            elapsedSeconds = 0;
            updateElapsedTimeDisplay();
            
            elapsedTimerInterval = setInterval(() => {
                elapsedSeconds++;
                updateElapsedTimeDisplay();
            }, 1000);
        }
        
        function updateElapsedTimeDisplay() {
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('elapsedTime').textContent = `â° å·²ç”¨æ™‚é–“ï¼š${timeStr}`;
        }
        
        function startTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerDisplay.textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                // æœ€å¾Œ30ç§’è­¦å‘Š
                if (timeRemaining <= 30) {
                    timerDisplay.classList.add('warning');
                }
                
                // æ™‚é–“åˆ°
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    finishTest();
                }
                
                // æ›´æ–°æ‰“å­—é€Ÿåº¦
                updateStats();
            }, 1000);
        }
        
        // ç›£è½æ‰“å­—è¼¸å…¥
        const typingInput = document.getElementById('typingInput');
        typingInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkRound();
            }
        });
        
        typingInput.addEventListener('input', () => {
            updateStats();
        });
        
        function checkRound() {
            const userInput = typingInput.value.trim();
            
            if (userInput.length === 0) {
                return; // ç©ºç™½ä¸ç®—
            }
            
            // ä½¿ç”¨ç•¶å‰çš„è©©å¥æª¢æŸ¥
            const currentPoem = getCurrentPoem();
            
            // è¨ˆç®—é€™è¼ªçš„éŒ¯èª¤
            const errors = calculateErrors(userInput, currentPoem);
            totalErrors += errors;
            totalChars += userInput.length;
            
            // è¨ˆç®—é€™è¼ªçš„å®Œæˆç‡
            const roundRate = calculateRoundCompletionRate(userInput, currentPoem);
            roundCompletionRates.push(roundRate);
            
            roundCount++;
            currentRound++;
            
            // åˆ‡æ›åˆ°ä¸‹ä¸€é¦–è©©
            nextPoem();
            
            // æ›´æ–°åœ–ç‰‡
            const poemImage = document.getElementById('poemImage');
            poemImage.src = `images/typing-poem${currentPoemIndex + 1}.png`;
            
            // æ›´æ–°è¼ªæ•¸é¡¯ç¤º
            const poemName = currentPoemIndex === 0 ? 'ã€Šé¹¿æŸ´ã€‹' : 'ã€Šé³¥é³´æ¾—ã€‹';
            document.getElementById('roundIndicator').textContent = 
                `ç¬¬ ${currentRound} è¼ª - ${poemName}`;
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            typingInput.value = '';
            
            // æ›´æ–°çµ±è¨ˆ
            updateStats();
        }
        
        function calculateErrors(userText, referenceText) {
            let errors = 0;
            const maxLen = Math.max(userText.length, referenceText.length);
            
            for (let i = 0; i < maxLen; i++) {
                const userChar = userText[i] || '';
                const refChar = referenceText[i] || '';
                
                if (userChar !== refChar) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºåŒéŸ³å­—
                    if (isHomophone(userChar, refChar)) {
                        errors += 0.5; // åŒéŸ³å­—ç®—åŠå€‹éŒ¯å­—
                    } else if (userChar !== '') {
                        errors += 1; // å®Œå…¨éŒ¯å­—
                    }
                }
            }
            
            return errors;
        }
        
        // è¨ˆç®—æ¯è¼ªå®Œæˆç‡ï¼ˆåŸºæ–¼æ­£ç¢ºå­—æ•¸ï¼‰
        function calculateRoundCompletionRate(userText, referenceText) {
            let correctScore = 0;
            const poemLength = 24; // å›ºå®š24å€‹å­—
            const maxLen = Math.max(userText.length, referenceText.length);
            
            for (let i = 0; i < referenceText.length; i++) {
                const userChar = userText[i] || '';
                const refChar = referenceText[i] || '';
                
                if (userChar === refChar) {
                    // å®Œå…¨æ­£ç¢º
                    correctScore += 1;
                } else if (isHomophone(userChar, refChar)) {
                    // åŒéŸ³å­—æˆ–æ¨™é»éŒ¯èª¤
                    correctScore += 0.5;
                }
                // å®Œå…¨éŒ¯èª¤æˆ–æœªè¼¸å…¥ï¼š+0 åˆ†
            }
            
            // å®Œæˆç‡ = (æ­£ç¢ºåˆ†æ•¸ / 24) Ã— 100%
            return (correctScore / poemLength) * 100;
        }
        
        function isHomophone(char1, char2) {
            if (!char1 || !char2) return false;
            const homophones = HOMOPHONE_MAP[char2];
            return homophones && homophones.includes(char1);
        }
        
        function updateStats() {
            // è¨ˆç®—ç•¶å‰è¼¸å…¥çš„éŒ¯èª¤ï¼ˆä¸è¨ˆå…¥ç¸½æ•¸ï¼Œåªé¡¯ç¤ºï¼‰
            const currentInput = typingInput.value;
            const currentPoem = getCurrentPoem();
            const currentErrors = calculateErrors(currentInput, currentPoem);
            
            // è¨ˆç®—ç•¶å‰è¼¸å…¥çš„å®Œæˆç‡ï¼ˆå³æ™‚é è¦½ï¼‰
            const currentRoundRate = calculateRoundCompletionRate(currentInput, currentPoem);
            
            // è¨ˆç®—ç¸½è¨ˆ
            const displayTotalChars = totalChars + currentInput.length;
            const displayTotalErrors = totalErrors + currentErrors;
            
            // å®Œæˆç‡ï¼šæ‰€æœ‰å·²å®Œæˆè¼ªæ¬¡çš„å¹³å‡ + ç•¶å‰è¼¸å…¥çš„å®Œæˆç‡
            let avgCompletionRate = 0;
            if (roundCompletionRates.length > 0 || currentInput.length > 0) {
                const allRates = [...roundCompletionRates];
                if (currentInput.length > 0) {
                    allRates.push(currentRoundRate);
                }
                avgCompletionRate = allRates.reduce((sum, rate) => sum + rate, 0) / allRates.length;
            }
            
            // æ­£ç¢ºç‡
            const accuracy = displayTotalChars > 0 
                ? ((displayTotalChars - displayTotalErrors) / displayTotalChars * 100)
                : 100;
            
            // æ‰“å­—é€Ÿåº¦ï¼ˆå­—/åˆ†é˜ï¼‰- åªè¨ˆç®—æ­£ç¢ºçš„å­—
            const correctChars = displayTotalChars - displayTotalErrors;
            const elapsedMinutes = (TEST_DURATION - timeRemaining) / 60;
            const wpm = elapsedMinutes > 0 
                ? Math.round(correctChars / elapsedMinutes)
                : 0;
            
            // é€Ÿåº¦åˆ†æ•¸ï¼ˆå‡è¨­60å­—/åˆ†ç‚ºæ»¿åˆ†100åˆ†ï¼‰
            const speedScore = Math.min((wpm / 60) * 100, 100);
            
            // ç¶œåˆåˆ†æ•¸ï¼ˆæ–¹æ¡ˆCï¼šå„33.3%ï¼‰
            const overallScore = (avgCompletionRate * 0.333 + accuracy * 0.333 + speedScore * 0.333);
            
            // æ‰¾å‡ºæœ€å¼·é …ï¼ˆä¹‹ç‹ï¼‰
            const scores = {
                completion: avgCompletionRate,
                accuracy: accuracy,
                speed: speedScore
            };
            const maxScore = Math.max(scores.completion, scores.accuracy, scores.speed);
            
            // æ¸…é™¤æ‰€æœ‰å¾½ç« 
            document.getElementById('completionBadge').innerHTML = '';
            document.getElementById('accuracyBadge').innerHTML = '';
            document.getElementById('speedBadge').innerHTML = '';
            
            // æ¨™ç¤ºä¹‹ç‹ï¼ˆåªæœ‰ç•¶è©²é … >= 80 æ‰é¡¯ç¤ºï¼‰
            if (scores.completion === maxScore && scores.completion >= 80) {
                document.getElementById('completionBadge').innerHTML = '<span style="color: #ffd700; font-size: 16px;">ğŸ‘‘</span>';
            }
            if (scores.accuracy === maxScore && scores.accuracy >= 80) {
                document.getElementById('accuracyBadge').innerHTML = '<span style="color: #ffd700; font-size: 16px;">ğŸ‘‘</span>';
            }
            if (scores.speed === maxScore && scores.speed >= 80) {
                document.getElementById('speedBadge').innerHTML = '<span style="color: #ffd700; font-size: 16px;">ğŸ‘‘</span>';
            }
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('overallScore').innerHTML = 
                `${overallScore.toFixed(0)}<span class="stat-unit" style="color: rgba(255,255,255,0.9);">åˆ†</span>`;
            document.getElementById('roundCount').innerHTML = 
                `${roundCount}<span class="stat-unit">è¼ª</span>`;
            document.getElementById('totalChars').innerHTML = 
                `${displayTotalChars}<span class="stat-unit">å­—</span>`;
            document.getElementById('errorCount').innerHTML = 
                `${displayTotalErrors.toFixed(1)}<span class="stat-unit">å­—</span>`;
            document.getElementById('completionRate').innerHTML = 
                `${avgCompletionRate.toFixed(1)}<span class="stat-unit">%</span>`;
            document.getElementById('accuracy').innerHTML = 
                `${accuracy.toFixed(1)}<span class="stat-unit">%</span>`;
            document.getElementById('wpm').innerHTML = 
                `${wpm}<span class="stat-unit">å­—/åˆ†</span>`;
        }
        
        function finishTest() {
            // å¦‚æœé‚„æœ‰æœªæäº¤çš„æ–‡å­—ï¼Œå…ˆæª¢æŸ¥
            if (typingInput.value.trim().length > 0) {
                checkRound();
            }
            
            typingInput.disabled = true;
            
            // è¨ˆç®—æœ€çµ‚çµ±è¨ˆ
            const correctChars = totalChars - totalErrors;
            const elapsedMinutes = TEST_DURATION / 60;
            const finalWPM = Math.round(correctChars / elapsedMinutes);
            const finalAccuracy = totalChars > 0 
                ? ((totalChars - totalErrors) / totalChars * 100)
                : 100;
            
            // è¨ˆç®—å¹³å‡å®Œæˆç‡
            const avgCompletionRate = roundCompletionRates.length > 0
                ? (roundCompletionRates.reduce((sum, rate) => sum + rate, 0) / roundCompletionRates.length)
                : 0;
            
            // é€Ÿåº¦åˆ†æ•¸ï¼ˆå‡è¨­60å­—/åˆ†ç‚ºæ»¿åˆ†ï¼‰
            const speedScore = Math.min((finalWPM / 60) * 100, 100);
            
            // ç¶œåˆåˆ†æ•¸ï¼ˆæ–¹æ¡ˆCï¼šå„33.3%ï¼‰
            const overallScore = (avgCompletionRate * 0.333 + finalAccuracy * 0.333 + speedScore * 0.333);
            
            // æ‰¾å‡ºæœ€å¼·é …
            const scores = {
                'å®Œæˆç‡': avgCompletionRate,
                'æ­£ç¢ºç‡': finalAccuracy,
                'é€Ÿåº¦': speedScore
            };
            let maxCategory = '';
            let maxValue = 0;
            for (let [category, value] of Object.entries(scores)) {
                if (value > maxValue) {
                    maxValue = value;
                    maxCategory = category;
                }
            }
            
            const kingBadge = maxValue >= 80 ? `\nğŸ† ${maxCategory}ä¹‹ç‹ï¼` : '';
            
            // æ™‚é–“åˆ°å¾Œè‡ªå‹•æäº¤æˆç¸¾
            submitTypingResult(roundCount, totalChars, totalErrors, avgCompletionRate, finalAccuracy, finalWPM, speedScore, overallScore, maxCategory);
        }
        
        // æäº¤æ‰“å­—æˆç¸¾å‡½æ•¸
        async function submitTypingResult(rounds, chars, errors, completionRate, accuracy, wpm, speedScore, overallScore, topCategoryName) {
            // æ‰¾å‡ºæœ€å¼·é …çš„è‹±æ–‡ä»£ç¢¼
            let topCategory = '';
            const scores = {
                completion: completionRate,
                accuracy: accuracy,
                speed: speedScore
            };
            let maxValue = Math.max(scores.completion, scores.accuracy, scores.speed);
            if (scores.completion === maxValue) topCategory = 'completion';
            else if (scores.accuracy === maxValue) topCategory = 'accuracy';
            else topCategory = 'speed';
            
            // å„²å­˜æ‰“å­—çµæœ
            studentData.typingResult = {
                overallScore: overallScore,
                topCategory: topCategory,
                rounds: rounds,
                totalChars: chars,
                errors: parseFloat(errors.toFixed(1)),
                completionRate: completionRate,
                roundCompletionRates: roundCompletionRates,
                accuracy: accuracy,
                wpm: wpm,
                speedScore: parseFloat(speedScore.toFixed(1)),
                duration: TEST_DURATION,
                completedTime: new Date().toISOString()
            };
            
            sessionStorage.setItem('studentData', JSON.stringify(studentData));
            
            // è¨ˆç®—ç¸½åˆ†
            const examScore = studentData.examResult.score;
            const totalScore = examScore + (wpm / 2);
            
            // å„²å­˜åˆ° Firebase
            const studentKey = `${studentData.class}_${studentData.number}_${studentData.name}`;
            
            const kingBadge = maxValue >= 80 ? `\nğŸ† ${topCategoryName}ä¹‹ç‹ï¼` : '';
            
            try {
                // å„²å­˜å®Œæ•´è³‡æ–™åˆ° exams
                await set(ref(database, `exams/${studentKey}`), {
                    name: studentData.name,
                    class: studentData.class,
                    number: studentData.number,
                    examResult: studentData.examResult,
                    typingResult: studentData.typingResult,
                    loginTime: studentData.loginTime
                });
                
                // å„²å­˜åˆ°æ’è¡Œæ¦œ
                await set(ref(database, `leaderboard/${studentKey}`), {
                    name: studentData.name,
                    class: studentData.class,
                    number: parseInt(studentData.number),
                    examScore: examScore,
                    typingWPM: wpm,
                    typingAccuracy: accuracy,
                    typingOverallScore: overallScore,
                    totalScore: Math.round(totalScore),
                    completedTime: new Date().toISOString()
                });
                
                alert(`â° æ‰“å­—æ¸¬é©—å®Œæˆï¼\n\nğŸ† ç¶œåˆåˆ†æ•¸ï¼š${overallScore.toFixed(0)} åˆ†${kingBadge}\n\nğŸ“Š å„é …æŒ‡æ¨™ï¼š\nå®Œæˆç‡ï¼š${completionRate.toFixed(1)}%\næ­£ç¢ºç‡ï¼š${accuracy.toFixed(1)}%\né€Ÿåº¦ï¼š${wpm} å­—/åˆ†\n\nå®Œæˆè¼ªæ•¸ï¼š${rounds} è¼ª\nç¸½å­—æ•¸ï¼š${chars} å­—\néŒ¯å­—æ•¸ï¼š${errors.toFixed(1)} å­—\nå·²ç”¨æ™‚é–“ï¼š${Math.floor(elapsedSeconds / 60)} åˆ† ${elapsedSeconds % 60} ç§’\n\nå³å°‡å‰å¾€æ’è¡Œæ¦œ...`);
                window.location.href = 'reward.html';
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜æˆç¸¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯çµ¡è€å¸«');
            }
        }
        
        // æäº¤æŒ‰éˆ•äº‹ä»¶
        document.getElementById('submitBtn').addEventListener('click', () => {
            // åœæ­¢æ‰€æœ‰è¨ˆæ™‚å™¨
            if (timerInterval) clearInterval(timerInterval);
            if (elapsedTimerInterval) clearInterval(elapsedTimerInterval);
            
            // è¨ˆç®—æœ€çµ‚çµ±è¨ˆ - é€Ÿåº¦åªè¨ˆç®—æ­£ç¢ºçš„å­—
            const correctChars = totalChars - totalErrors;
            const finalWPM = elapsedSeconds > 0 
                ? Math.round((correctChars / elapsedSeconds) * 60)
                : 0;
            const finalAccuracy = totalChars > 0 
                ? ((totalChars - totalErrors) / totalChars * 100)
                : 100;
            
            const avgCompletionRate = roundCompletionRates.length > 0
                ? (roundCompletionRates.reduce((sum, rate) => sum + rate, 0) / roundCompletionRates.length)
                : 0;
            
            const speedScore = Math.min((finalWPM / 60) * 100, 100);
            const overallScore = (avgCompletionRate * 0.333 + finalAccuracy * 0.333 + speedScore * 0.333);
            
            // æ‰¾å‡ºæœ€å¼·é …
            const scores = {
                'å®Œæˆç‡': avgCompletionRate,
                'æ­£ç¢ºç‡': finalAccuracy,
                'é€Ÿåº¦': speedScore
            };
            let maxCategory = '';
            let maxValue = 0;
            for (let [category, value] of Object.entries(scores)) {
                if (value > maxValue) {
                    maxValue = value;
                    maxCategory = category;
                }
            }
            
            submitTypingResult(roundCount, totalChars, totalErrors, avgCompletionRate, finalAccuracy, finalWPM, speedScore, overallScore, maxCategory);
        });
    </script>
</body>
</html>
